// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String
  password  String
  role      UserRole
  phone     String?
  joinDate  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Role-specific relations
  admin    Admin?
  faculty  Faculty?
  student  Student?

  @@map("users")
}

model Admin {
  id           String @id @default(cuid())
  userId       String @unique
  department   String
  office       String
  workingHours String
  permissions  String[]

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("admins")
}

model Faculty {
  id             String @id @default(cuid())
  userId         String @unique
  employeeId     String @unique
  department     String
  office         String
  specialization String
  officeHours    String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  courses            Course[]
  classSchedules     ClassSchedule[]
  attendanceRecords  AttendanceRecord[]
  componentApprovals ComponentRequest[]
  project_requests   ProjectRequest[]

  @@map("faculty")
}

model Student {
  id        String @id @default(cuid())
  userId    String @unique
  studentId String @unique
  program   String
  year      String
  section   String
  gpa       Float?
  advisorId String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  enrollments        Enrollment[]
  projectSubmissions ProjectSubmission[]
  attendanceRecords  StudentAttendance[]
  componentRequests  ComponentRequest[]
  project_requests   ProjectRequest[]

  @@map("students")
}

model Course {
  id              String @id @default(cuid())
  code            String @unique
  name            String
  description     String
  credits         Int
  department      String
  semester        String
  maxStudents     Int
  enrolledStudents Int   @default(0)
  status          CourseStatus @default(ACTIVE)
  sections        String[]
  facultyId       String

  faculty Faculty @relation(fields: [facultyId], references: [id])

  // Relations
  enrollments    Enrollment[]
  classSchedules ClassSchedule[]

  @@map("courses")
}

model Enrollment {
  id        String @id @default(cuid())
  studentId String
  courseId  String
  section   String
  enrolledAt DateTime @default(now())

  student Student @relation(fields: [studentId], references: [id])
  course  Course  @relation(fields: [courseId], references: [id])

  @@unique([studentId, courseId])
  @@map("enrollments")
}

model ClassSchedule {
  id        String @id @default(cuid())
  courseId  String
  facultyId String
  room      String
  dayOfWeek String
  startTime String
  endTime   String
  section   String

  course  Course  @relation(fields: [courseId], references: [id])
  faculty Faculty @relation(fields: [facultyId], references: [id])

  @@map("class_schedules")
}

model Project {
  id                        String   @id @default(cuid())
  created_by                String
  modified_by               String?
  created_date              DateTime @default(now())
  modified_date             DateTime @updatedAt
  name                      String
  components_needed         String[] // Array of component IDs
  expected_completion_date  DateTime
  course_id                 String // Course ID
  accepted_by               String? // Faculty ID (only for student-created projects)
  description               String
  status                    ProjectStatus @default(PENDING)
  type                      ProjectType @default(FACULTY_ASSIGNED) // FACULTY_ASSIGNED or STUDENT_PROPOSED

  // Relations
  submissions      ProjectSubmission[]
  project_requests ProjectRequest[]

  @@map("projects")
}

model ProjectSubmission {
  id             String @id @default(cuid())
  projectId      String
  studentId      String
  submissionDate DateTime @default(now())
  content        String
  attachments    String[]
  marks          Int?
  feedback       String?
  status         SubmissionStatus @default(SUBMITTED)

  project Project @relation(fields: [projectId], references: [id])
  student Student @relation(fields: [studentId], references: [id])

  @@unique([projectId, studentId])
  @@map("project_submissions")
}

model ProjectRequest {
  id             String   @id @default(cuid())
  project_id     String
  student_id     String
  faculty_id     String
  request_date   DateTime @default(now())
  status         ProjectRequestStatus @default(PENDING)
  student_notes  String?
  faculty_notes  String?
  accepted_date  DateTime?
  rejected_date  DateTime?

  project Project @relation(fields: [project_id], references: [id])
  student Student @relation(fields: [student_id], references: [id])
  faculty Faculty @relation(fields: [faculty_id], references: [id])

  @@unique([project_id, student_id])
  @@map("project_requests")
}

model AttendanceRecord {
  id        String @id @default(cuid())
  courseId  String
  facultyId String
  section   String
  date      DateTime
  createdAt DateTime @default(now())

  faculty Faculty @relation(fields: [facultyId], references: [id])

  // Relations
  studentAttendance StudentAttendance[]

  @@map("attendance_records")
}

model StudentAttendance {
  id                 String @id @default(cuid())
  attendanceRecordId String
  studentId          String
  status             AttendanceStatus

  attendanceRecord AttendanceRecord @relation(fields: [attendanceRecordId], references: [id])
  student          Student          @relation(fields: [studentId], references: [id])

  @@unique([attendanceRecordId, studentId])
  @@map("student_attendance")
}

model LabComponent {
  id                    String   @id @default(uuid())
  component_name        String
  component_description String
  component_specification String?
  component_quantity    Int
  component_tag_id      String?
  component_category    String
  component_location    String
  
  // Image handling - separate path and ID for flexibility
  image_path            String   @default("lab-images")
  front_image_id        String?
  back_image_id         String?
  
  // Purchase details
  invoice_number        String?
  purchase_value        Decimal? @db.Decimal(10, 2)
  purchased_from        String?
  purchase_currency     String   @default("INR")
  purchase_date         DateTime?
  
  // Audit fields
  created_by            String
  created_date          DateTime @default(now())
  modified_date         DateTime @updatedAt
  modified_by           String?
  
  // Relations
  requests              ComponentRequest[]
  
  // Indexes for better performance
  @@index([component_category])
  @@index([component_location])
  @@index([created_by])
  @@map("lab_components")
}

model ComponentRequest {
  id                 String @id @default(cuid())
  student_id         String
  component_id       String
  faculty_id         String?
  quantity           Int
  request_date       DateTime @default(now())
  expected_return_date DateTime
  collection_date    DateTime?
  return_date        DateTime?
  status             RequestStatus @default(PENDING)
  notes              String?
  faculty_notes      String?

  student   Student      @relation(fields: [student_id], references: [id])
  component LabComponent @relation(fields: [component_id], references: [id])
  faculty   Faculty?     @relation(fields: [faculty_id], references: [id])

  @@map("component_requests")
}

model Location {
  id          String @id @default(cuid())
  name        String
  building    String
  floor       String?
  capacity    Int?
  type        LocationType
  facilities  String[]
  isAvailable Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("locations")
}

// Enums
enum UserRole {
  ADMIN
  FACULTY
  STUDENT
}

enum CourseStatus {
  ACTIVE
  INACTIVE
  COMPLETED
}

enum ProjectStatus {
  PENDING
  ONGOING
  COMPLETED
  OVERDUE
  REJECTED
}

enum SubmissionStatus {
  SUBMITTED
  GRADED
  LATE
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  COLLECTED
  PENDING_RETURN
  RETURNED
  OVERDUE
}

enum LocationType {
  CLASSROOM
  LABORATORY
  AUDITORIUM
  OFFICE
  LIBRARY
}

enum ProjectType {
  FACULTY_ASSIGNED
  STUDENT_PROPOSED
}

enum ProjectRequestStatus {
  PENDING
  APPROVED
  REJECTED
}
